#!/usr/bin/env python3
import os, warnings, subprocess, pygame, sys, time, datetime, threading
from restrict_keys import disable_keys

os.environ['PYGAME_HIDE_SUPPORT_PROMPT'] = "hide"
warnings.filterwarnings("ignore", message=".*avx2.*")

PASSWORD = "4242"
IMAGE_PATH = "/home/etaquet/Pictures/background.jpg"
FPS = 30
IDLE_TIMEOUT = 10  # seconds before screen off
SSH_PORT = "42312"
SSH_USER = "etaquet"
HOST_IP_FILE = "/home/etaquet/share/Host-IP"

# --- get host IP dynamically ---
try:
	with open(HOST_IP_FILE, "r") as f:
		HOST_IP = f.read().strip()
except Exception:
	HOST_IP = "127.0.0.1"  # fallback

def ssh_dpms(state: str):
	"""Send xset dpms force on/off to the host."""
	if state not in ("on", "suspend", "off"):
		return
	cmd = [
		"ssh", "-p", SSH_PORT,
		f"{SSH_USER}@{HOST_IP}",
		f"DISPLAY=:0 xset dpms force {state}"
	]
	try:
		subprocess.run(cmd, stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
	except Exception:
		pass

pygame.init()
info = pygame.display.Info()
WIDTH, HEIGHT = info.current_w, info.current_h
screen = pygame.display.set_mode((WIDTH, HEIGHT), pygame.FULLSCREEN | pygame.NOFRAME)
pygame.display.set_caption("42 ft_lock")
pygame.mouse.set_visible(False)

# Colors and fonts
TEXT_COLOR = (102, 51, 153)
ERROR_COLOR = (255, 50, 50)
INPUT_BG = (30, 30, 30)
INPUT_FG = (200, 200, 200)
large_font = pygame.font.SysFont("monospace", HEIGHT // 10, bold=True)
medium_font = pygame.font.SysFont("monospace", HEIGHT // 20, bold=True)
small_font = pygame.font.SysFont("monospace", HEIGHT // 30, bold=True)

# Load background image
try:
	bg_image = pygame.image.load(IMAGE_PATH)
	bg_image = pygame.transform.scale(bg_image, (WIDTH, HEIGHT))
except:
	bg_image = None

input_text = ""
show_error = False
error_time = 0
last_activity = time.time()

def handle_events():
	global input_text, show_error, error_time, last_activity
	for event in pygame.event.get():
		if event.type == pygame.QUIT:
			pass
		elif event.type in (pygame.KEYDOWN, pygame.MOUSEMOTION, pygame.MOUSEBUTTONDOWN):
			last_activity = time.time()
			if event.type == pygame.KEYDOWN:
				if event.key == pygame.K_RETURN:
					if input_text == PASSWORD:
						raise SystemExit
					else:
						show_error = True
						error_time = time.time()
						input_text = ""
				elif event.key == pygame.K_BACKSPACE:
					input_text = input_text[:-1]
				else:
					if event.unicode.isalnum() and len(input_text) < 20:
						input_text += event.unicode

# Run keyboard filter in a separate thread so pygame loop can continue
keyboard_thread = threading.Thread(target=disable_keys, daemon=True)
keyboard_thread.start()
clock = pygame.time.Clock()

try:
	while True:
		current_time = time.time()
		handle_events()

		# idle timeout -> turn off host screen
		if current_time - last_activity > IDLE_TIMEOUT:
			last_activity = time.time()
			ssh_dpms("suspend")

		if show_error and current_time - error_time > 2:
			show_error = False

		# still draw, but it wonâ€™t matter when host display is off
		if bg_image:
			screen.blit(bg_image, (0, 0))
		else:
			screen.fill((0, 0, 0))

		now = datetime.datetime.now()
		time_surface = large_font.render(now.strftime("%H:%M:%S"), True, TEXT_COLOR)
		time_rect = time_surface.get_rect(center=(WIDTH//2, HEIGHT//2))
		screen.blit(time_surface, time_rect)

		date_surface = medium_font.render(now.strftime("%A, %B %d, %Y"), True, TEXT_COLOR)
		date_rect = date_surface.get_rect(center=(WIDTH//2, HEIGHT//2 + HEIGHT//10))
		screen.blit(date_surface, date_rect)

		prompt_surface = small_font.render("Enter password:", True, TEXT_COLOR)
		prompt_rect = prompt_surface.get_rect(center=(WIDTH//2, HEIGHT//2 + HEIGHT//6))
		screen.blit(prompt_surface, prompt_rect)

		input_box_width = WIDTH // 3
		input_box_height = HEIGHT // 20
		input_rect = pygame.Rect(WIDTH//2 - input_box_width//2, HEIGHT//2 + HEIGHT//5,
								input_box_width, input_box_height)
		pygame.draw.rect(screen, INPUT_BG, input_rect)

		text_display = "Get_Jinxed"
		display_text = "".join(text_display[i % len(text_display)] for i in range(len(input_text)))
		input_surface = small_font.render(display_text, True, INPUT_FG)
		input_surface_rect = input_surface.get_rect(center=input_rect.center)
		screen.blit(input_surface, input_surface_rect)

		if show_error:
			error_surface = small_font.render("Incorrect password", True, ERROR_COLOR)
			error_rect = error_surface.get_rect(center=(WIDTH//2, HEIGHT//2 + HEIGHT//5 + input_box_height + 30))
			screen.blit(error_surface, error_rect)

		pygame.display.flip()
		clock.tick(FPS)
finally:
	pygame.quit()
	sys.exit()
